<!DOCTYPE html>
<html lang="zh-hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/icon_small.png" asp-append-version="true">
    <link rel="icon" type="image/png" href="/img/favicon.ico" asp-append-version="true">
        <title>
            @ViewData["Title"] - 食譜魔方
        </title>
    <!--     字型跟圖標     -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chocolate+Classical+Sans&display=swap" rel="stylesheet">
    <!-- SVG圖標 -->
    <link href="/css/nucleo-icons.css" rel="stylesheet" />
    <link href="/css/nucleo-svg.css" rel="stylesheet" />
    <!-- Font Awesome 圖標 -->
    <link href="/lib/font-awesome/css/all.min.css" rel="stylesheet" />
    <!-- CSS -->
    <link id="pagestyle" href="/css/soft-ui-dashboard.css?v=1.0.3" rel="stylesheet" />
    <link rel="stylesheet" href="/css/site.css" asp-append-version="true" />
    <link href="/lib/datatables/datatables.min.css" rel="stylesheet" asp-append-version="true">
    <!-- select2插件 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <!-- animate -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <!--Sidebar的顏色及icon顯示-->  
    <style>
        /* 預設圖標顏色 */
        .nav-link i {
            color: #333; /* 沒有點擊時的顏色 */
        }
        /* 點擊時的顏色 */
        .nav-link.active i {
            color:#FFFFFF;
        }
        /* 懸停時的顏色 */
        .nav-link:hover i {
            color:#FF9224;
        }
    </style>
    <!-- 連結View內style -->
    @await RenderSectionAsync("Styles", required: false)
</head>

<body class="g-sidenav-show bg-gray-100 chocolate-classical-sans-regular">
    <!-- Sidebar -->
    <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 " id="sidenav-main">
        <div class="sidenav-header">
            <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
            <a class="navbar-brand m-0" href="">
                <img src="/img/icon_small.png" class="navbar-brand-img h-100" alt="main_logo">
                <span class="ms-1 font-weight-bold">RecipeCube</span>
            </a>
        </div>
        <hr class="horizontal dark mt-0">
        <div class="collapse navbar-collapse  w-auto  max-height-vh-100 h-100" id="sidenav-collapse-main">
            <ul class="navbar-nav" href="javascript:void(0)">
                <li id="Home" class="nav-item">
                    <a class="nav-link  active" asp-area="Admin" asp-controller="Home" asp-action="Index">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-house-chimney" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">總覽</span>
                    </a>
                </li>
                <li id="User" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-user" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">使用者</span>
                    </a>
                </li>
                <li id="Group" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-users" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">群組</span>
                    </a>
                </li>
                <li id="PreferedFood" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-hand-holding-heart" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">使用者偏好食材</span>
                    </a>
                </li>
                <li id="ExclusiveFood" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-skull" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">使用者不可食用食材</span>
                    </a>
                </li>
                <li id="Inventory" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-box-open" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">庫存</span>
                    </a>
                </li>
                <li id="Pantry" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-file-lines" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">庫存管理紀錄</span>
                    </a>
                </li>
                <li id="Ingredient" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-utensils" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">食材</span>
                    </a>
                </li>
                <li id="RecipeIngredient" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-right-left" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">食材食譜關聯</span>
                    </a>
                </li>
                <li id="Recipe" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-book-bookmark" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">食譜</span>
                    </a>
                </li>
                <li id="Product" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-brands fa-shopify" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">商品</span>
                    </a>
                </li>
                <li id="Order" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-file-import" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">訂單</span>
                    </a>
                </li>
                <li id="OrderItem" class="nav-item">
                    <a class="nav-link" href="javascript:void(0)">
                        <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
                            <i class="fa-solid fa-file-signature" style="font-size: 0.9rem;"></i>
                        </div>
                        <span class="nav-link-text ms-1">訂單明細</span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>
    <!-- End Sidebar -->

    <main class="main-content position-relative max-height-vh-100 h-100 mt-1 border-radius-lg ">
        <!-- Navbar -->
        <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
            <div class="container-fluid py-1 px-3">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
                        <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">首頁</a></li>
                        <li class="breadcrumb-item text-sm text-dark active" aria-current="page">@ViewData["Title"]</li>
                    </ol>
                    <h6 class="font-weight-bolder mb-0">@ViewData["Title"]</h6>
                </nav>
                <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
                    <div class="ms-md-auto pe-md-3 d-flex align-items-center">
                        <div class="input-group">
                            <span class="input-group-text text-body"><i class="fas fa-search" aria-hidden="true"></i></span>
                            <input type="text" class="form-control" placeholder="請輸入...">
                        </div>
                    </div>
                    <ul class="navbar-nav  justify-content-end">
                        <li class="nav-item d-flex align-items-center">
                            @* 註冊&登入&登出  *@
                            <partial name="_LoginPartial" />
                        </li>
                        <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
                            <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                                <div class="sidenav-toggler-inner">
                                    <i class="sidenav-toggler-line"></i>
                                    <i class="sidenav-toggler-line"></i>
                                    <i class="sidenav-toggler-line"></i>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item px-3 d-flex align-items-center">
                            <a href="javascript:;" class="nav-link text-body p-0">
                                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- End Navbar -->
        <!-- Main content -->
        <div class="container-fluid py-4">
            <div class="row card">
                <div id="dynamic-content">
                    @RenderBody()
                </div>
            </div>
            <!-- End Main content -->

            <footer class="footer pt-3  ">
                <div class="container-fluid">
                    <div class="row align-items-center justify-content-lg-between">
                        <div class="col-lg-6 mb-lg-0 mb-4">
                            <div class="copyright text-center text-sm text-muted text-lg-start">
                                © <script>
                                      document.write(new Date().getFullYear())
                                </script>,
                                made with <i class="fa fa-heart"></i> by Creative Tim for a better web.
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                                <li class="nav-item">
                                    <a href="https://www.creative-tim.com/license" class="nav-link pe-0 text-muted" target="_blank">License</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </main>

    <!--   核心JS   -->

    <script src="/js/core/popper.min.js"></script>
    <script src="/js/core/bootstrap.min.js"></script>
    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="/js/plugins/smooth-scrollbar.min.js"></script>
    <script src="/lib/datatables/datatables.min.js"></script>
    <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="/js/soft-ui-dashboard.min.js?v=1.0.3"></script>
    <!-- 掛載validation驗證js -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <!-- 掛載 select2 js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <!-- 連結View內script -->
    <script>
        $(document).ready(function () {
            let controller = '';
            let parentId = '';
            let filterRow = null;
            // 定義一個全局的 orderId 變數
            let orderId = null;
            let orderpass = false;

            // 初始化Sidebar卷軸
            if (navigator.userAgent.indexOf('Win') > -1 && document.querySelector('#sidenav-scrollbar')) {
                Scrollbar.init(document.querySelector('#sidenav-scrollbar'), { damping: '0.5' });
            }

            function initializePerfectScrollbar(selector) {
                new PerfectScrollbar(selector, { damping: 0.5 });
            }

            function initializeDataTableWithFilter(columnIndex) {
                new DataTable("table", {
                    initComplete: function () {
                        if (columnIndex !== null) {
                            var column = this.api().column(columnIndex);
                            let label = document.createElement('label');
                            label.innerHTML = '篩選:';
                            label.classList.add('ms-5');
                            let select = document.createElement('select');
                            select.classList.add('form-select', 'form-select-sm', 'ms-1', 'w-50');
                            select.add(new Option(''));
                            select.addEventListener('change', function () {
                                column.search(this.value).draw();
                            });
                            $("div.dt-length").css('white-space', 'nowrap');
                            $("div.dt-length label").after(label, select);
                            column.data().unique().sort().each(function (d) {
                                select.add(new Option(d));
                            });
                        }
                    },
                    language: {
                        url: "//cdn.datatables.net/plug-ins/2.1.6/i18n/zh-HANT.json",
                        paginate: { first: "«", previous: "‹", next: "›", last: "»" },
                    },
                });
            }

            // 載入Partial
            function loadPartial() {
                $.ajax({
                    url: `/Admin/${controller}/${parentId}IndexPartial`,
                    type: 'GET',
                    success: function (data) {
                        $('#dynamic-content').html(data);
                        initializeDataTableWithFilter(filterRow);
                        // 根據每個局部檢視返回的標題設置頁面標題
                        var newTitle = $('#dynamic-content').find('h1').text();
                        //console.log(newTitle);
                        document.title = newTitle + ' - 食譜魔方';  // 設置頁面標題
                        //console.log(document.title);
                        // 更新麵包屑
                        $('ol.breadcrumb .breadcrumb-item.active').text(newTitle);
                        $('h6.font-weight-bolder').text(newTitle);
                    },
                    error: function (xhr, status, error) {
                        alert("Error: " + error);
                    }
                });
            }

            // 載入Modal
            function loadModalData(url, modalSelector, successCallback) {
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function (data) {
                        $(modalSelector + ' .modal-body').html(data);
                        initializePerfectScrollbar(modalSelector + ' .modal-body');
                        $(modalSelector).modal('show');
                        if (successCallback) successCallback();
                    },
                    error: function () {
                        alert('發生錯誤，無法載入資料');
                    }
                });
            }

            // 處理Form的Submit
            function handleFormSubmit(formSelector, modalSelector) {
                $(document).on('submit', formSelector, function (e) {
                    e.preventDefault();
                    // 使用 FormData 來處理文件上傳
                    var formData = new FormData(this);
                    // 根據 controller 或 parentId 決定是否需要處理 Select2 的食材數據
                    if (controller === 'Recipes' || parentId === 'Recipe') {
                        // 獲取 Select2 選中的食材
                        if ($('#selectedIngredients').length) {
                            var selectedIngredients = $('#selectedIngredients').val();
                            selectedIngredients.forEach(function (ingredientId) {
                                formData.append('SelectedIngredients', ingredientId); // 使用 append 將選擇的食材添加到 FormData 中
                            });
                        }
                        // 獲取食材的數量
                        $('input[name^="IngredientQuantities"]').each(function () {
                            var ingredientId = $(this).attr('name').match(/\[(\d+)\]/)[1];
                            var quantity = $(this).val();
                            formData.append('IngredientQuantities[' + ingredientId + ']', quantity); // 將數量也加入到 FormData
                        });
                    }
                    $.ajax({
                        url: $(this).attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false, // 不處理資料
                        contentType: false, // 不設置內容類型
                        traditional: true,
                        success: function (response) {
                            if (response.success) {
                                $(modalSelector).modal('hide');
                                if (controller === "OrderItems" && orderId && orderpass == true) {
                                    // 使用帶有 orderId 的載入方法
                                    loadPartialWithOrderId(orderId);
                                } else {
                                    loadPartial();
                                }
                            } else {
                                $(modalSelector + ' .modal-body').html(response);
                            }
                        },
                        error: function () {
                            alert('發生錯誤，無法保存');
                        }
                    });
                });
            } 


            // Sidebar的反應
            $("ul.navbar-nav .nav-link").on('click', function (e) {
                $("ul.navbar-nav .nav-link").removeClass("active");
                $(this).addClass("active");
                parentId = $(this).parent().attr('id');
                if (parentId !== "Home") {
                    e.preventDefault();
                }
                $('#dynamic-content').html('<div>Loading...</div>');

                switch (parentId) {
                    case 'User': controller = 'Users'; filterRow = null; break;
                    case 'Group': controller = 'UserGroups'; filterRow = null; break;
                    case 'PreferedFood': controller = 'PreferedIngredients'; filterRow = null; break;
                    case 'ExclusiveFood': controller = 'ExclusiveIngredients'; filterRow = null; break;
                    case 'Inventory': controller = 'Inventories'; filterRow = 0; break;
                    case 'Pantry': controller = 'PantryManagements'; filterRow = 0; break;
                    case 'Ingredient': controller = 'Ingredients'; filterRow = 1; break;
                    case 'RecipeIngredient': controller = 'RecipeIngredients'; filterRow = 3; break;
                    case 'Recipe': controller = 'Recipes'; filterRow = 2; break;
                    case 'Product': controller = 'Products'; filterRow = null; break;
                    case 'Order': controller = 'Orders'; filterRow = null; break;
                    case 'OrderItem': controller = 'OrderItems'; filterRow = null; orderpass = false; break;
                    default: console.error('Controller 未定義或 parentId 為 Home'); return;
                }
                loadPartial();
            });

            $(document).on('click', '.edit', function () {
                let id = $(this).data('id');
                loadModalData(`/Admin/${controller}/EditPartial/` + id, '#editModal');
            });

            $(document).on('click', '.detail', function () {
                let id = $(this).data('id');
                loadModalData(`/Admin/${controller}/DetailsPartial/` + id, '#detailsModal');
            });

            $(document).on('click', '.create', function () {
                loadModalData(`/Admin/${controller}/CreatePartial`, '#createModal');
            });

            $(document).on('click', '.delete', function () {
                let id = $(this).data('id');
                loadModalData(`/Admin/${controller}/DeletePartial/` + id, '#deleteModal');
            });

            $(document).on('click', '#openeditModal', function () {
                let id = $(this).data('id');
                $('#detailsModal').modal('hide');
                loadModalData(`/Admin/${controller}/EditPartial/` + id, '#editModal');
            });

            // Form的submit
            handleFormSubmit('#editForm', '#editModal');
            handleFormSubmit('#createForm', '#createModal');
            handleFormSubmit('#deleteForm', '#deleteModal');

            // Modal關閉時的反應
            $('.modal').on('hidden.bs.modal', function () {
                $(this).find('.modal-body').html('');  // 清空 modal 內容
                loadPartial();
            });

            //給訂單跳轉到訂單詳細時用的Code
            $(document).on('click', '.detailOrder', function (e) {
                e.preventDefault();  // 阻止預設行為

                $("ul.navbar-nav .nav-link").removeClass("active");  // 清除其他項目的 active 狀態
                $("#OrderItem").children(".nav-link").addClass("active");  // 設定訂單明細項目為 active

                orderId = $(this).data('id');  // 獲取按鈕的 data-id (即 orderId)
                orderpass = true;
                controller = 'OrderItems';  // 切換 controller 為 'OrderItems'
                parentId = 'OrderItem';
                filterRow = 0;  // 設置篩選的列索引，這裡假設 orderId 是第一列 (索引 0)
                
                // 更新動態內容
                $('#dynamic-content').html('<div>Loading...</div>');

                // 發送 AJAX 請求載入 OrderItems 的部分檢視
                $.ajax({
                    url: '/Admin/OrderItems/OrderItemIndexPartial',  // 設定目標 URL，指向 OrderItems 的局部檢視
                    type: 'POST',
                    data: { orderid: orderId },  // 傳遞 orderId 作為參數
                    success: function (data) {
                        $('#dynamic-content').html(data);  // 更新 DOM 為返回的部分檢視

                        // 初始化 DataTable 並直接篩選
                        var table = new DataTable("table", {
                            initComplete: function () {
                                // 自動篩選與 orderId 相關的訂單
                                initializeFilters(this, orderId);  // 傳遞 orderId 作為預設篩選值
                            },
                            language: {
                                url: "//cdn.datatables.net/plug-ins/2.1.6/i18n/zh-HANT.json",
                                paginate: { first: "«", previous: "‹", next: "›", last: "»" },
                            },
                        });
                    },
                    error: function (xhr, status, error) {
                        alert("Error: " + error);
                    }
                });
                // 使用自定義的 loadPartialWithOrderId 來處理包含 orderId 的部分檢視跳轉
                loadPartialWithOrderId(orderId);
            });

            // 初始化篩選選項
            function initializeFilters(dtInstance, orderId) {
                var columnIndex = 0;  // 假設 orderId 在第一列 (index = 0)
                var column = dtInstance.api().column(columnIndex);
                let label = document.createElement('label');
                label.innerHTML = '篩選:';
                label.classList.add('ms-5');
                let select = document.createElement('select');
                select.classList.add('form-select', 'form-select-sm', 'ms-1', 'w-50');
                select.add(new Option('')); // 添加空選項

                // 添加可選項
                column.data().unique().sort().each(function (d) {
                    select.add(new Option(d));
                });

                // 設置預設值為 orderId 並自動觸發篩選
                select.value = orderId;  // 將選擇框的值設為 orderId
                select.addEventListener('change', function () {
                    column.search(this.value).draw();  // 當選擇改變時，進行篩選
                });

                // 自動觸發篩選
                column.search(orderId).draw();  // 直接觸發篩選
                $("div.dt-length").css('white-space', 'nowrap');
                $("div.dt-length label").after(label, select);
            }
            // 給特定情況的 loadPartial 函數，處理包含 orderId 的跳轉
            function loadPartialWithOrderId(orderId) {
                // 使用全局變數 controller 來判斷當前控制器
                $.ajax({
                    url: `/Admin/${controller}/${parentId}IndexPartial`,  // 動態控制器和局部檢視路徑
                    type: 'GET',
                    data: { orderid: orderId },  // 傳遞 orderId 作為參數
                    success: function (data) {
                        $('#dynamic-content').html(data);  // 更新 DOM

                        // 初始化 DataTable 並應用篩選條件
                        var table = new DataTable("table", {
                            initComplete: function () {
                                initializeFilters(this, orderId);  // 將 orderId 作為篩選條件
                            },
                            language: {
                                url: "//cdn.datatables.net/plug-ins/2.1.6/i18n/zh-HANT.json",
                                paginate: { first: "«", previous: "‹", next: "›", last: "»" },
                            },
                        });
                    },
                    error: function (xhr, status, error) {
                        alert("Error: " + error);
                    }
                });
            }



        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)

</body>
</html>